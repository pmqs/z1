name: MacOS

on: [push, pull_request, workflow_dispatch]
jobs:
  configure:
    name: ${{ matrix.os }} + ${{ matrix.compiler }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - macos-latest
        # protos:
        # #   - 0
        #   - 1
        # lzma:
        #   - 0
        #   - 1
        # ppmd:
        #   - 0
        #   - 1

        compiler:
          - gcc-13
          - gcc-12
          - gcc-11

          - clang
        #   - clang-14
        #   - clang-13


    steps:

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        show-progress: 'false'
        ref: build

    - name: Display ${{ matrix.compiler }} version
      run: ${{ matrix.compiler }} -v

    - name: configure (unix/Makefile)
      run: |
        make -f unix/Makefile flags CC=${{ matrix.compiler }}

    - name: change the flags file protos=${{ matrix.protos }} lzma=${{ matrix.lzma }}
      run: |
          # if [ "${{ matrix.protos }}" -eq "1" ]
          # then
          #   sed -i.bak -e 's/-DNO_PROTO//' flags
          # else
          #   sed -i.bak -e 's/CF="/CF=" -DNO_PROTO /' flags
          # fi
          # if [ "${{ matrix.lzma }}" -eq "1" ]
          # then
          #   sed -i.bak -e 's/CF="/CF=" -DLZMA_SUPPORT /' flags
          # else
          #   sed -i.bak -e 's/-DLZMA_SUPPORT//' flags
          # fi
          # if [ "${{ matrix.ppmd }}" -eq "1" ]
          # then
          #   sed -i.bak -e 's/CF="/CF=" -DPPMD_SUPPORT /' flags
          # else
          #   sed -i.bak -e 's/-DPPMD_SUPPORT//' flags
          # fi
          sed -i.bak -e 's/CF="/CF=" -Werror /' flags
          cat flags

    - name: build (unix/Makefile)
      run: |
            make -f unix/Makefile generic CC=${{ matrix.compiler }}

    - name: Run zip --help
      run: ./zip --help

    - name: Run zip -v
      run: ./zip -v

    - name: Run zipcloak --help
      run: ./zipcloak --help

    - name: Run zipcloak -v
      run: ./zipcloak -v

    - name: Run zipnote --help
      run: ./zipnote --help

    - name: Run zipnote -v
      run: ./zipnote -v

    - name: Run zipsplit --help
      run: ./zipsplit --help

    - name: Run zipsplit -v
      run: ./zipsplit -v


    # - name: Upload build errors
    #   uses: actions/upload-artifact@v3
    #   if: failure()
    #   with:
    #     name: ${{ matrix.name }} (configure)
    #     path: |
    #       **/Makefile
    #       ${{ matrix.build-dir || '.' }}/configure.log
    #     retention-days: 30